#!/bin/bash

# MySQL Database Script for Nuxeo Development
# This script manages a MySQL Docker container for Nuxeo development

set -e

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source common library
source "${SCRIPT_DIR}/lib/common.sh"

# Default configuration
CONTAINER_NAME="nuxeo-mysql-dev"
DB_PORT="3306"
DB_NAME="nuxeo"
DB_USER="nuxeo"
DB_PASSWORD="nuxeo"
DB_ROOT_PASSWORD="root"
MYSQL_VERSION="8.0"
VOLUME_NAME="nuxeo-mysql-data"
FOLLOW_LOGS="true"

# Parse options
parse_options() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --container-name)
                CONTAINER_NAME="$2"
                shift 2
                ;;
            --port)
                DB_PORT="$2"
                shift 2
                ;;
            --name)
                DB_NAME="$2"
                shift 2
                ;;
            --user)
                DB_USER="$2"
                shift 2
                ;;
            --password)
                DB_PASSWORD="$2"
                shift 2
                ;;
            --root-password)
                DB_ROOT_PASSWORD="$2"
                shift 2
                ;;
            --version)
                MYSQL_VERSION="$2"
                shift 2
                ;;
            --volume-name)
                VOLUME_NAME="$2"
                shift 2
                ;;
            --debug)
                DEBUG="true"
                shift
                ;;
            --no-follow)
                FOLLOW_LOGS="false"
                shift
                ;;
            start|stop|restart|status|clean|logs|console|help|--help|-h)
                # Command found, return to process it
                return 0
                ;;
            *)
                print_error "Unknown option: $1"
                show_help
                exit 1
                ;;
        esac
    done
}

# Function to start MySQL
start_mysql() {
    check_docker
    
    if container_running "$CONTAINER_NAME"; then
        print_warn "MySQL container '${CONTAINER_NAME}' is already running."
        return 0
    fi
    
    if container_exists "$CONTAINER_NAME"; then
        print_info "Starting existing MySQL container '${CONTAINER_NAME}'..."
        docker start "${CONTAINER_NAME}"
    else
        print_info "Creating and starting new MySQL container '${CONTAINER_NAME}'..."
        docker run -d \
            --name "${CONTAINER_NAME}" \
            -p "${DB_PORT}:3306" \
            -e MYSQL_DATABASE="${DB_NAME}" \
            -e MYSQL_USER="${DB_USER}" \
            -e MYSQL_PASSWORD="${DB_PASSWORD}" \
            -e MYSQL_ROOT_PASSWORD="${DB_ROOT_PASSWORD}" \
            -v "${VOLUME_NAME}:/var/lib/mysql" \
            "mysql:${MYSQL_VERSION}" \
            --character-set-server=utf8mb4 \
            --collation-server=utf8mb4_unicode_ci
    fi
    
    # Wait for MySQL to be ready
    wait_for_container "MySQL" \
        "docker exec ${CONTAINER_NAME} mysqladmin ping -h localhost -u root -p${DB_ROOT_PASSWORD}"
    
    # Print connection details
    print_connection_details \
        "Host: localhost" \
        "Port: ${DB_PORT}" \
        "Database: ${DB_NAME}" \
        "User: ${DB_USER}" \
        "Password: ${DB_PASSWORD}" \
        "Root Password: ${DB_ROOT_PASSWORD}" \
        "JDBC URL: jdbc:mysql://localhost:${DB_PORT}/${DB_NAME}"
}

# Function to stop MySQL
stop_mysql() {
    stop_container "$CONTAINER_NAME" "MySQL"
}

# Function to restart MySQL
restart_mysql() {
    stop_mysql
    start_mysql
}

# Function to show status
show_status() {
    show_container_status "$CONTAINER_NAME" "MySQL"
}

# Function to clean up (remove container and volume)
clean_mysql() {
    clean_container "$CONTAINER_NAME" "$VOLUME_NAME" "MySQL"
}

# Function to show logs
show_logs() {
    show_container_logs "$CONTAINER_NAME" "MySQL" "$FOLLOW_LOGS"
}

# Function to run console mode (start and follow logs)
run_console() {
    run_console_mode start_mysql "$CONTAINER_NAME" "MySQL" "$DB_NAME"
}

# Function to show help
show_help() {
    echo "MySQL Database Script for Nuxeo Development"
    echo ""
    echo "Usage: $0 [OPTIONS] {start|stop|restart|status|clean|logs|console|help}"
    echo ""
    echo "Commands:"
    echo "  start    - Start MySQL container"
    echo "  stop     - Stop MySQL container"
    echo "  restart  - Restart MySQL container"
    echo "  status   - Show container status"
    echo "  clean    - Remove container and data volume"
    echo "  logs     - Show container logs (follow mode)"
    echo "  console  - Start MySQL and follow logs"
    echo "  help     - Show this help message"
    echo ""
    echo "Options:"
    echo "  --container-name NAME  Container name (default: nuxeo-mysql-dev)"
    echo "  --port PORT            Host port (default: 3306)"
    echo "  --name NAME            Database name (default: nuxeo)"
    echo "  --user USER            Database user (default: nuxeo)"
    echo "  --password PASS        Database password (default: nuxeo)"
    echo "  --root-password PASS   Root password (default: root)"
    echo "  --version VERSION      MySQL version (default: 8.0)"
    echo "  --volume-name NAME     Volume name (default: nuxeo-mysql-data)"
    echo "  --debug                Enable debug logging"
    echo "  --no-follow            Don't follow logs (for logs command)"
    echo ""
    echo "Examples:"
    echo "  $0 --port 3307 start"
    echo "  $0 --name mydb --user myuser --password mypass start"
    echo "  $0 --debug start"
}

# Parse options first
parse_options "$@"

# Find the command
COMMAND=""
for arg in "$@"; do
    if is_supported_command "$arg"; then
        COMMAND="$arg"
        break
    fi
done

# Main script logic
case "${COMMAND}" in
    start)
        start_mysql
        ;;
    stop)
        stop_mysql
        ;;
    restart)
        restart_mysql
        ;;
    status)
        show_status
        ;;
    clean)
        clean_mysql
        ;;
    logs)
        show_logs
        ;;
    console)
        run_console
        ;;
    help|--help|-h)
        show_help
        ;;
    "")
        print_error "No command specified"
        echo ""
        show_help
        exit 1
        ;;
    *)
        print_error "Invalid command: ${COMMAND}"
        echo ""
        show_help
        exit 1
        ;;
esac
