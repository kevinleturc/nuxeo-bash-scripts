#!/bin/bash

# MongoDB Database Script for Nuxeo Development
# This script manages a MongoDB Docker container for Nuxeo development

set -e

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source common library
source "${SCRIPT_DIR}/lib/common.sh"

# Default configuration
CONTAINER_NAME="nuxeo-mongodb-dev"
DB_PORT="27017"
DB_NAME="nuxeo"
DB_USER="nuxeo"
DB_PASSWORD="nuxeo"
MONGO_VERSION="6.0"
VOLUME_NAME="nuxeo-mongodb-data"
FOLLOW_LOGS="true"

# Parse options
parse_options() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --container-name)
                CONTAINER_NAME="$2"
                shift 2
                ;;
            --port)
                DB_PORT="$2"
                shift 2
                ;;
            --name)
                DB_NAME="$2"
                shift 2
                ;;
            --user)
                DB_USER="$2"
                shift 2
                ;;
            --password)
                DB_PASSWORD="$2"
                shift 2
                ;;
            --version)
                MONGO_VERSION="$2"
                shift 2
                ;;
            --volume-name)
                VOLUME_NAME="$2"
                shift 2
                ;;
            --debug)
                DEBUG="true"
                shift
                ;;
            --no-follow)
                FOLLOW_LOGS="false"
                shift
                ;;
            start|stop|restart|status|clean|logs|help|--help|-h)
                # Command found, return to process it
                return 0
                ;;
            *)
                print_error "Unknown option: $1"
                show_help
                exit 1
                ;;
        esac
    done
}

# Function to start MongoDB
start_mongodb() {
    check_docker
    
    if container_running "$CONTAINER_NAME"; then
        print_warn "MongoDB container '${CONTAINER_NAME}' is already running."
        return 0
    fi
    
    if container_exists "$CONTAINER_NAME"; then
        print_info "Starting existing MongoDB container '${CONTAINER_NAME}'..."
        docker start "${CONTAINER_NAME}"
    else
        print_info "Creating and starting new MongoDB container '${CONTAINER_NAME}'..."
        docker run -d \
            --name "${CONTAINER_NAME}" \
            -p "${DB_PORT}:27017" \
            -e MONGO_INITDB_ROOT_USERNAME="${DB_USER}" \
            -e MONGO_INITDB_ROOT_PASSWORD="${DB_PASSWORD}" \
            -e MONGO_INITDB_DATABASE="${DB_NAME}" \
            -v "${VOLUME_NAME}:/data/db" \
            "mongo:${MONGO_VERSION}"
    fi
    
    # Wait for MongoDB to be ready
    wait_for_container "MongoDB" \
        "docker exec ${CONTAINER_NAME} mongosh --quiet --eval \"db.adminCommand('ping')\""
    
    # Print connection details
    print_connection_details \
        "Host: localhost" \
        "Port: ${DB_PORT}" \
        "Database: ${DB_NAME}" \
        "User: ${DB_USER}" \
        "Password: ${DB_PASSWORD}" \
        "Connection String: mongodb://${DB_USER}:${DB_PASSWORD}@localhost:${DB_PORT}/${DB_NAME}?authSource=admin"
}

# Function to stop MongoDB
stop_mongodb() {
    stop_container "$CONTAINER_NAME" "MongoDB"
}

# Function to restart MongoDB
restart_mongodb() {
    stop_mongodb
    start_mongodb
}

# Function to show status
show_status() {
    show_container_status "$CONTAINER_NAME" "MongoDB"
}

# Function to clean up (remove container and volume)
clean_mongodb() {
    clean_container "$CONTAINER_NAME" "$VOLUME_NAME" "MongoDB"
}

# Function to show logs
show_logs() {
    show_container_logs "$CONTAINER_NAME" "MongoDB" "$FOLLOW_LOGS"
}

# Function to show help
show_help() {
    echo "MongoDB Database Script for Nuxeo Development"
    echo ""
    echo "Usage: $0 [OPTIONS] {start|stop|restart|status|clean|logs|help}"
    echo ""
    echo "Commands:"
    echo "  start    - Start MongoDB container"
    echo "  stop     - Stop MongoDB container"
    echo "  restart  - Restart MongoDB container"
    echo "  status   - Show container status"
    echo "  clean    - Remove container and data volume"
    echo "  logs     - Show container logs (follow mode)"
    echo "  help     - Show this help message"
    echo ""
    echo "Options:"
    echo "  --container-name NAME  Container name (default: nuxeo-mongodb-dev)"
    echo "  --port PORT            Host port (default: 27017)"
    echo "  --name NAME            Database name (default: nuxeo)"
    echo "  --user USER            Database user (default: nuxeo)"
    echo "  --password PASS        Database password (default: nuxeo)"
    echo "  --version VERSION      MongoDB version (default: 6.0)"
    echo "  --volume-name NAME     Volume name (default: nuxeo-mongodb-data)"
    echo "  --debug                Enable debug logging"
    echo "  --no-follow            Don't follow logs (for logs command)"
    echo ""
    echo "Examples:"
    echo "  $0 --port 27018 start"
    echo "  $0 --name mydb --user myuser --password mypass start"
    echo "  $0 --debug start"
}

# Parse options first
parse_options "$@"

# Find the command
COMMAND=""
for arg in "$@"; do
    case "$arg" in
        start|stop|restart|status|clean|logs|help|--help|-h)
            COMMAND="$arg"
            break
            ;;
    esac
done

# Main script logic
case "${COMMAND}" in
    start)
        start_mongodb
        ;;
    stop)
        stop_mongodb
        ;;
    restart)
        restart_mongodb
        ;;
    status)
        show_status
        ;;
    clean)
        clean_mongodb
        ;;
    logs)
        show_logs
        ;;
    help|--help|-h)
        show_help
        ;;
    "")
        print_error "No command specified"
        echo ""
        show_help
        exit 1
        ;;
    *)
        print_error "Invalid command: ${COMMAND}"
        echo ""
        show_help
        exit 1
        ;;
esac
